<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekend Split â€” Minimal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0f1724;
    --plate:#eef0f3;
    --success:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#fff,#f3f4f6);display:flex;align-items:center;justify-content:center;border:1px solid #e6e9ee;font-weight:700}
  h1{margin:0;font-size:18px;font-weight:600}
  .subtitle{font-size:13px;color:var(--muted);margin-top:2px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(15,23,36,0.06)}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(14,16,20,0.04);border:1px solid rgba(15,23,36,0.03);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px}
  @media(max-width:920px){.grid{grid-template-columns:1fr}.right{order:2}}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:#fff;font-size:14px;outline:none}
  textarea{min-height:64px;resize:vertical}
  .row{display:flex;gap:8px}
  .small{font-size:13px;color:var(--muted)}
  .people-list{display:flex;flex-wrap:wrap;gap:8px}
  .person-chip{padding:6px 10px;background:var(--plate);border-radius:12px;font-weight:600;font-size:13px;border:1px solid rgba(15,23,36,0.03);cursor:pointer}
  .expense{display:flex;justify-content:space-between;gap:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,36,0.03);margin-bottom:8px}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .tiny{padding:6px 8px;border-radius:8px;font-size:13px}
  .icon-btn{background:transparent;border:none;padding:6px;border-radius:8px;cursor:pointer}
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--plate);margin-bottom:8px;border:1px solid rgba(15,23,36,0.03)}
  .positive{color:var(--success);font-weight:700}
  .negative{color:var(--danger);font-weight:700}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  .footer{font-size:13px;color:var(--muted);display:flex;justify-content:space-between;margin-top:8px}
  .file{display:none}
  .list-scroll{max-height:320px;overflow:auto;padding-right:6px}
  .select-inline{display:flex;gap:8px;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid rgba(15,23,36,0.04);font-weight:600}
  .small-muted{font-size:12px;color:var(--muted)}
  .center{display:flex;align-items:center;justify-content:center}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(10,12,15,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--card);padding:14px;border-radius:12px;width:min(640px,96%);box-shadow:0 20px 50px rgba(2,6,23,0.4)}
  .flex{display:flex;gap:8px}
  /* share target style */
  .share-icon{font-size:18px;padding:8px;border-radius:8px;border:1px solid rgba(15,23,36,0.03);background:#fff;cursor:pointer}
  .category-chip{padding:6px 10px;background:#fff;border-radius:10px;border:1px solid rgba(15,23,36,0.03);font-weight:600;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">WS</div>
      <div>
        <h1>Weekend Split</h1>
        <div class="subtitle">Groups â€¢ Categories â€¢ Rounded splits â€¢ Share summary</div>
      </div>
    </div>
    <div class="controls">
      <button id="downloadBtn" class="btn tiny">Download JSON</button>
      <button id="resetAll" class="btn ghost tiny">Reset All</button>
    </div>
  </header>

  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div class="select-inline">
        <label style="margin:0 6px 0 0;font-weight:600">Group</label>
        <select id="groupSelect"></select>
        <button id="newGroupBtn" class="btn ghost tiny">New</button>
        <button id="delGroupBtn" class="btn ghost tiny">Delete</button>
      </div>
      <div class="small-muted">All data saved locally on this device</div>
    </div>
  </div>

  <div class="grid">
    <div>
      <!-- People -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">People</div>
          <div class="small-muted">Tap name to remove</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="personName" type="text" placeholder="Add person (eg. Ramesh)">
          <button id="addPerson" class="btn tiny">Add</button>
        </div>
        <div style="margin-top:10px" id="peopleList" class="people-list"></div>
      </div>

      <!-- Categories -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Categories</div>
          <div class="small-muted">Add / Remove categories</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="catName" type="text" placeholder="New category (eg. Food)">
          <button id="addCat" class="btn tiny">Add</button>
        </div>
        <div id="catList" class="people-list" style="margin-top:10px"></div>
      </div>

      <!-- Expense form -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Add / Edit Expense</div>
          <div class="small-muted">Amounts rounded to whole rupees</div>
        </div>

        <div style="margin-top:10px">
          <label>Payer</label>
          <select id="payerSelect"></select>

          <label>Amount</label>
          <input id="amountInput" type="number" min="0" step="1" />

          <label>Category</label>
          <select id="categorySelect"></select>

          <label>Participants</label>
          <div id="participants" class="people-list"></div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveExpense" class="btn">Save</button>
            <button id="clearExpense" class="btn ghost">Clear</button>
          </div>
        </div>
      </div>

      <!-- Expenses list -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Expenses</div>
          <div class="small-muted" id="expCount">0 items</div>
        </div>
        <div class="list-scroll" id="expensesList" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="right">
      <!-- Summary + share -->
      <div class="card" id="summaryCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Summary</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="shareBtn" class="share-icon" title="Share summary">ðŸ“¤</div>
            <div class="small-muted">Share as image</div>
          </div>
        </div>

        <div id="summaryWrap" style="margin-top:12px">
          <div class="small-muted">Category totals</div>
          <div id="categoryTotals" style="margin-top:8px"></div>

          <div style="height:8px"></div>

          <div class="small-muted">Net balances</div>
          <div id="summary" style="margin-top:8px"></div>
        </div>

        <div style="height:10px"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="font-weight:700">Transfer flow</div>
          <div class="small-muted">Choose collector</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <select id="transferTo" style="flex:1"></select>
          <button id="computeTransfer" class="btn tiny">Compute</button>
        </div>

        <div id="transferResult" style="margin-top:12px"></div>

        <div class="note">Logic: Debtors transfer their amount to the chosen person; that person then forwards payments to creditors.</div>
      </div>

      <!-- Actions -->
      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Quick Actions</div>
          <div class="small-muted">Backup / Restore</div>
        </div>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
          <button id="copySummary" class="btn">Copy Summary Text</button>
          <button id="downloadBackup" class="btn ghost">Download Backup</button>
          <input id="uploadFile" type="file" accept="application/json" class="file" />
          <button id="restoreBtn" class="btn tiny">Restore from file</button>
        </div>
        <div class="footer"><div>Version 1.2</div><div class="small-muted">Local only â€¢ No accounts</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div id="modal" class="modal-back">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700" id="editTitle">Edit Expense</div>
      <button id="closeModal" class="icon-btn" title="Close">âœ•</button>
    </div>
    <div style="margin-top:10px">
      <label>Payer</label>
      <select id="editPayer"></select>
      <label>Amount</label>
      <input id="editAmount" type="number" min="0" step="1" />
      <label>Category</label>
      <select id="editCategory"></select>
      <label>Participants</label>
      <div id="editParticipants" class="people-list" style="margin-top:6px"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="applyEdit" class="btn">Apply</button>
        <button id="deleteExpense" class="btn ghost">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- html2canvas (for share) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNa5m3c0q2t2y2JfB2sZl+XxE8b0a4s1u4R3H8B2rNqg2r1YVg0W5q2k8h9K2U1T9xQ1J2d3j4k5L6M7N8O9Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
(function(){
  // ====== Data model & storage ======
  const KEY = 'ws_full_v1';
  function uid(){ return Math.random().toString(36).slice(2,9); }
  let data = { groups: [] };
  let currentGroupId = null;
  let editingId = null;

  // DOM refs
  const groupSelect = d('groupSelect');
  const newGroupBtn = d('newGroupBtn');
  const delGroupBtn = d('delGroupBtn');
  const addPersonBtn = d('addPerson');
  const personName = d('personName');
  const peopleList = d('peopleList');
  const payerSelect = d('payerSelect');
  const amountInput = d('amountInput');
  const categorySelect = d('categorySelect');
  const participantsDiv = d('participants');
  const saveExpense = d('saveExpense');
  const clearExpense = d('clearExpense');
  const expensesList = d('expensesList');
  const expCount = d('expCount');
  const summaryDiv = d('summary');
  const categoryTotalsDiv = d('categoryTotals');
  const transferTo = d('transferTo');
  const computeTransfer = d('computeTransfer');
  const transferResult = d('transferResult');
  const shareBtn = d('shareBtn');
  const downloadBtn = d('downloadBtn');
  const resetAll = d('resetAll');
  const catName = d('catName');
  const addCat = d('addCat');
  const catList = d('catList');
  const downloadBackup = d('downloadBackup');
  const uploadFile = d('uploadFile');
  const restoreBtn = d('restoreBtn');
  const copySummary = d('copySummary');

  const modal = d('modal');
  const closeModal = d('closeModal');
  const editPayer = d('editPayer');
  const editAmount = d('editAmount');
  const editCategory = d('editCategory');
  const editParticipants = d('editParticipants');
  const applyEdit = d('applyEdit');
  const deleteExpenseBtn = d('deleteExpense');

  // helper to get element
  function d(id){ return document.getElementById(id); }

  // load/save
  function save(){
    try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){ console.error(e); alert('Could not save data'); }
  }
  function load(){
    const s = localStorage.getItem(KEY);
    if(s){ try{ data = JSON.parse(s); }catch(e){ console.error(e); data = {groups:[]}; } }
  }

  // init defaults if empty
  load();
  if(!data.groups || !data.groups.length){
    const gId = uid();
    data.groups = [{
      id: gId,
      name: 'Friends',
      people: [],
      categories: ['Food','Entertainment','Fuel','Shopping'],
      expenses: []
    }];
    currentGroupId = gId;
    save();
  } else {
    currentGroupId = data.groups[0].id;
  }
  renderAll();

  // ====== Groups ======
  newGroupBtn.addEventListener('click', ()=>{
    const name = prompt('Group name') || ('Group-'+(data.groups.length+1));
    const g = { id: uid(), name: name.trim(), people: [], categories: ['Food','Entertainment','Fuel','Shopping'], expenses: [] };
    data.groups.push(g);
    currentGroupId = g.id;
    save(); renderAll();
  });

  groupSelect.addEventListener('change', e=>{
    currentGroupId = e.target.value; renderAll();
  });

  delGroupBtn.addEventListener('click', ()=>{
    const g = cur();
    if(!g) return;
    if(!confirm('Delete group "'+g.name+'"? This removes people & expenses.')) return;
    data.groups = data.groups.filter(x=>x.id!==g.id);
    currentGroupId = data.groups.length? data.groups[0].id : null;
    if(!currentGroupId){
      const id = uid();
      data.groups.push({id, name:'Friends', people:[], categories:['Food','Entertainment','Fuel','Shopping'], expenses:[]});
      currentGroupId = id;
    }
    save(); renderAll();
  });

  // ====== People ======
  addPersonBtn.addEventListener('click', ()=>{
    const name = personName.value.trim(); if(!name) return alert('Enter a name');
    const g = cur(); g.people.push({id:uid(), name}); personName.value=''; save(); renderAll();
  });

  peopleList.addEventListener('click', ev=>{
    const pid = ev.target.dataset && ev.target.dataset.pid;
    if(!pid) return;
    const g = cur();
    const p = g.people.find(x=>x.id===pid);
    if(!p) return;
    if(!confirm('Remove '+p.name+'? This will remove them from expenses.')) return;
    // remove person and clean expenses
    g.people = g.people.filter(x=>x.id!==pid);
    g.expenses = g.expenses.map(ex=>({ ...ex, participants: ex.participants.filter(x=>x!==pid), payer: ex.payer===pid? (g.people[0]?g.people[0].id:null) : ex.payer }))
                          .filter(ex=>ex.participants && ex.participants.length>0);
    save(); renderAll();
  });

  // ====== Categories ======
  addCat.addEventListener('click', ()=>{
    const name = catName.value.trim(); if(!name) return;
    const g = cur();
    if(g.categories.includes(name)) return alert('Category exists');
    g.categories.push(name); catName.value=''; save(); renderAll();
  });

  catList.addEventListener('click', ev=>{
    const cid = ev.target.dataset && ev.target.dataset.cat;
    if(!cid) return;
    const g = cur();
    if(g.categories.length<=1) return alert('At least one category required');
    if(!confirm('Remove category "'+cid+'" ? Expenses in this category will remain unchanged.')) return;
    g.categories = g.categories.filter(c=>c!==cid);
    save(); renderAll();
  });

  // ====== Expenses ======
  saveExpense.addEventListener('click', ()=>{
    const g = cur(); if(!g) return;
    const payer = payerSelect.value;
    let amt = Math.round(Number(amountInput.value || 0));
    const cat = categorySelect.value;
    const parts = Array.from(participantsDiv.querySelectorAll('input[type=checkbox]')).filter(ch=>ch.checked).map(ch=>ch.value);
    if(!payer) return alert('Select payer');
    if(!amt || amt<=0) return alert('Enter amount');
    if(parts.length===0) return alert('Select participants');
    const ex = { id: uid(), payer, amt: Math.round(amt), participants: parts, category: cat, ts: Date.now() };
    g.expenses.push(ex); save();
    amountInput.value=''; participantsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
    renderAll();
  });

  clearExpense.addEventListener('click', ()=>{
    amountInput.value=''; participantsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
  });

  // edit modal handlers
  function openEdit(eid){
    const g = cur(); const ex = g.expenses.find(x=>x.id===eid); if(!ex) return;
    editingId = eid;
    modal.style.display = 'flex';
    editPayer.innerHTML = ''; editParticipants.innerHTML = ''; editCategory.innerHTML = '';
    g.people.forEach(p=> { const o = document.createElement('option'); o.value=p.id; o.textContent=p.name; if(p.id===ex.payer) o.selected=true; editPayer.appendChild(o); });
    g.categories.forEach(c=> { const o = document.createElement('option'); o.value=c; o.textContent=c; if(c===ex.category) o.selected=true; editCategory.appendChild(o); });
    editAmount.value = ex.amt; // participants
    g.people.forEach(p=>{
      const lab = document.createElement('label'); lab.className='person-chip'; lab.style.display='inline-flex'; lab.style.alignItems='center';
      lab.innerHTML = `<input type="checkbox" style="margin-right:8px" value="${p.id}"> ${p.name}`;
      editParticipants.appendChild(lab);
    });
    // set checked
    editParticipants.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.checked = ex.participants.includes(cb.value));
  }

  closeModal.addEventListener('click', ()=>{ modal.style.display='none'; editingId = null; });

  applyEdit.addEventListener('click', ()=>{
    const g = cur(); if(!g || !editingId) return;
    const ex = g.expenses.find(x=>x.id===editingId); if(!ex) return;
    const payer = editPayer.value;
    const amt = Math.round(Number(editAmount.value || 0));
    const cat = editCategory.value;
    const parts = Array.from(editParticipants.querySelectorAll('input[type=checkbox]')).filter(ch=>ch.checked).map(ch=>ch.value);
    if(!payer) return alert('Select payer');
    if(!amt || amt<=0) return alert('Enter amount');
    if(parts.length===0) return alert('Select participants');
    ex.payer = payer; ex.amt = Math.round(amt); ex.category = cat; ex.participants = parts; ex.ts = Date.now();
    save(); modal.style.display='none'; editingId=null; renderAll();
  });

  deleteExpenseBtn.addEventListener('click', ()=>{
    if(!confirm('Delete this expense?')) return;
    const g = cur(); g.expenses = g.expenses.filter(x=>x.id!==editingId); save(); modal.style.display='none'; editingId=null; renderAll();
  });

  // expenses list click (edit/delete via buttons)
  function expensesRender(){
    const g = cur();
    expensesList.innerHTML = '';
    if(!g) return;
    expCount.textContent = g.expenses.length + ' items';
    if(g.expenses.length===0){ expensesList.innerHTML = '<div class="small-muted">No expenses</div>'; return; }
    g.expenses.slice().reverse().forEach(ex=>{
      const payerName = g.people.find(p=>p.id===ex.payer)?.name || 'Unknown';
      const partNames = ex.participants.map(pid => g.people.find(p=>p.id===pid)?.name || '?').join(', ');
      const div = document.createElement('div'); div.className='expense';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${ex.category} â€¢ â‚¹${ex.amt}</div>
                        <div class="muted">${payerName} paid â€¢ split among ${partNames}</div>
                        <div class="small-muted">${new Date(ex.ts).toLocaleString()}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='8px';
      const editB = document.createElement('button'); editB.className='tiny icon-btn'; editB.title='Edit'; editB.innerHTML='âœŽ';
      editB.addEventListener('click', ()=> openEdit(ex.id));
      const delB = document.createElement('button'); delB.className='tiny icon-btn'; delB.title='Delete'; delB.innerHTML='ðŸ—‘';
      delB.addEventListener('click', ()=>{ if(confirm('Delete this expense?')){ g.expenses = g.expenses.filter(x=>x.id!==ex.id); save(); renderAll(); }});
      right.appendChild(editB); right.appendChild(delB);
      div.appendChild(left); div.appendChild(right);
      expensesList.appendChild(div);
    });
  }

  // ====== Calculations ======
  // compute balances (integers only). Positive = creditor (should receive), Negative = debtor (owes)
  function computeBalances(){
    const g = cur(); const bal = {}; if(!g) return bal;
    g.people.forEach(p=> bal[p.id]=0);
    g.expenses.forEach(e=>{
      const n = e.participants.length;
      // integer split using floor and distribute remainder +1 to first participants
      const base = Math.floor(e.amt / n);
      let rem = e.amt - base * n;
      e.participants.forEach(pid=>{
        let share = base + (rem>0?1:0);
        if(rem>0) rem--;
        bal[pid] = (bal[pid] || 0) - share;
      });
      bal[e.payer] = (bal[e.payer] || 0) + e.amt;
    });
    // ensure integer rounding (already integers)
    Object.keys(bal).forEach(k=> bal[k] = Math.round(bal[k]));
    return bal;
  }

  // category totals
  function computeCategoryTotals(){
    const g = cur(); const ct = {}; if(!g) return ct;
    g.categories.forEach(c=> ct[c]=0);
    g.expenses.forEach(e=> {
      if(!ct[e.category]) ct[e.category]=0;
      ct[e.category] += e.amt;
    });
    return ct;
  }

  // render summary area
  function renderSummary(){
    const g = cur(); summaryDiv.innerHTML=''; categoryTotalsDiv.innerHTML=''; transferResult.innerHTML='';
    if(!g) return;
    // categories
    const ct = computeCategoryTotals();
    const categories = Object.keys(ct);
    categories.forEach(c=>{
      const row = document.createElement('div'); row.className='summary-row';
      row.innerHTML = `<div>${c}</div><div class="badge">â‚¹${ct[c] || 0}</div>`;
      categoryTotalsDiv.appendChild(row);
    });
    // net balances
    const bal = computeBalances();
    const list = g.people.map(p=>({id:p.id,name:p.name,amt:bal[p.id]||0})).sort((a,b)=>b.amt-a.amt);
    list.forEach(item=>{
      const row = document.createElement('div'); row.className='summary-row';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${item.name}</div><div class="small-muted">Net</div>`;
      const right = document.createElement('div'); right.innerHTML = `<div class="${item.amt>=0?'positive':'negative'}">â‚¹${Math.abs(item.amt)}</div>`;
      row.appendChild(left); row.appendChild(right);
      summaryDiv.appendChild(row);
    });
  }

  // render transfer select
  function renderTransferSelect(){
    const g = cur(); transferTo.innerHTML=''; if(!g) return;
    g.people.forEach(p=> { const opt = document.createElement('option'); opt.value=p.id; opt.textContent=p.name; transferTo.appendChild(opt); });
  }

  computeTransfer.addEventListener('click', ()=>{
    const g = cur(); if(!g) return;
    const toId = transferTo.value; if(!toId) return alert('Select collector');
    const bal = computeBalances();
    const creditors = []; const debtors = [];
    for(const pid in bal){
      const v = bal[pid];
      if(v>0) creditors.push({id:pid,amt:v});
      else if(v<0) debtors.push({id:pid,amt:-v});
    }
    // each debtor -> toId
    const ops = [];
    let totalToReceive = 0;
    debtors.forEach(d=>{ if(d.id===toId) return; ops.push({from:d.id,to:toId,amt:d.amt}); totalToReceive += d.amt; });
    // if toId itself was debtor, they'd also be in debtors; above skip ensures not self-pay
    const toInitial = bal[toId] || 0;
    const toAfter = toInitial + totalToReceive;
    // pay other creditors (excluding toId)
    const otherCreds = creditors.filter(c=>c.id !== toId).map(c=>({...c}));
    let remaining = toAfter;
    otherCreds.forEach(c=>{
      if(remaining<=0) return;
      const pay = Math.min(remaining, c.amt);
      if(pay>0){ ops.push({from:toId,to:c.id,amt:pay}); remaining -= pay; }
    });
    // produce textual flow
    renderTransferOps(ops, g);
  });

  function renderTransferOps(ops, g){
    transferResult.innerHTML='';
    if(!ops.length){ transferResult.innerHTML = '<div class="small-muted">Nothing to transfer â€” settled</div>'; return; }
    const map = {}; g.people.forEach(p=> map[p.id]=p.name);
    // group by same from->to aggregate
    const agg = {};
    ops.forEach(o=>{ const k = o.from+'|'+o.to; agg[k] = (agg[k] || 0) + o.amt; });
    Object.keys(agg).forEach(k=>{
      const [from,to] = k.split('|'); const amt = agg[k];
      const row = document.createElement('div'); row.className='summary-row';
      row.innerHTML = `<div>${map[from] || '?'} â†’ ${map[to] || '?'}</div><div class="badge">â‚¹${amt}</div>`;
      transferResult.appendChild(row);
    });
  }

  // ====== Share as image (summaryWrap) ======
  shareBtn.addEventListener('click', async ()=>{
    const wrap = d('summaryWrap');
    if(!wrap) return;
    // temporarily apply white background for better capture
    const oldBG = wrap.style.background;
    wrap.style.background = '#ffffff';
    try{
      const canvas = await html2canvas(wrap, {backgroundColor: null, scale: window.devicePixelRatio || 2});
      const dataURL = canvas.toDataURL('image/png');
      // convert to blob
      const res = await fetch(dataURL);
      const blob = await res.blob();
      const file = new File([blob], 'weekend-summary.png', {type:'image/png'});
      // use Web Share if available with files (mobile)
      if(navigator.canShare && navigator.canShare({files:[file]})){
        await navigator.share({ files: [file], title: 'Weekend Summary' }).catch(()=>{/*ignore*/});
      } else {
        // fallback: open image in new tab so user can long-press share/save
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      }
    }catch(err){
      console.error(err); alert('Could not generate image');
    }finally{
      wrap.style.background = oldBG;
    }
  });

  // ====== Quick actions: copy summary text, backup/restore ======
  copySummary.addEventListener('click', ()=>{
    const g = cur(); if(!g) return;
    const bal = computeBalances(); const ct = computeCategoryTotals();
    let s = `Group: ${g.name}\n\nCategory totals:\n`;
    Object.keys(ct).forEach(c=> s += `${c}: â‚¹${ct[c]}\n`);
    s += `\nBalances:\n`;
    g.people.forEach(p=> s += `${p.name}: â‚¹${Math.round(bal[p.id]||0)}\n`);
    // transfer suggestion (auto pick top positive as target for readable sentence example)
    const creditors = []; const debtors = [];
    for(const pid in bal){ const v = Math.round(bal[pid]); if(v>0) creditors.push({id:pid,amt:v}); else if(v<0) debtors.push({id:pid,amt:-v}); }
    if(creditors.length && debtors.length){
      // simple suggestion: everyone pays to largest creditor
      creditors.sort((a,b)=>b.amt-a.amt);
      const main = creditors[0];
      s += `\nSuggested flow:\nEveryone pays ${g.people.find(p=>p.id===main.id).name}.\n`;
      // then main pays others (if main not only creditor)
      const others = creditors.slice(1);
      others.forEach(o=> s += `${g.people.find(p=>p.id===main.id).name} transfers â‚¹${o.amt} to ${g.people.find(p=>p.id===o.id).name}.\n`);
    }
    navigator.clipboard.writeText(s).then(()=> alert('Summary copied to clipboard'));
  });

  downloadBackup.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'ws-backup.json'; a.click(); URL.revokeObjectURL(url);
  });

  restoreBtn.addEventListener('click', ()=> uploadFile.click());
  uploadFile.addEventListener('change', ev=>{
    const f = ev.target.files[0]; if(!f) return;
    const rdr = new FileReader();
    rdr.onload = e=>{ try{ const obj = JSON.parse(e.target.result); data = obj; if(data.groups && data.groups.length) currentGroupId = data.groups[0].id; save(); renderAll(); alert('Restored'); }catch(err){ alert('Invalid file') } };
    rdr.readAsText(f);
  });

  downloadBtn.addEventListener('click', ()=>{
    const s = JSON.stringify(data);
    const blob = new Blob([s], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download='ws-data.json'; a.click(); URL.revokeObjectURL(url);
  });

  resetAll.addEventListener('click', ()=>{
    if(!confirm('Clear all groups & data?')) return;
    data = { groups: [] };
    const gId = uid();
    data.groups.push({id:gId,name:'Friends',people:[],categories:['Food','Entertainment','Fuel','Shopping'],expenses:[]});
    currentGroupId = gId;
    save(); renderAll();
  });

  // ====== Utilities & rendering glue ======
  function cur(){ return data.groups.find(g=>g.id===currentGroupId) || null; }

  function renderAll(){
    renderGroups();
    renderPeople();
    renderCategories();
    renderExpenseForm();
    expensesRender();
    renderSummary();
    renderTransferSelect();
  }

  function renderGroups(){
    groupSelect.innerHTML = '';
    data.groups.forEach(g=>{
      const o = document.createElement('option'); o.value=g.id; o.textContent=g.name;
      if(g.id===currentGroupId) o.selected = true;
      groupSelect.appendChild(o);
    });
  }

  function renderPeople(){
    const g = cur();
    peopleList.innerHTML = '';
    payerSelect.innerHTML = '';
    participantsDiv.innerHTML = '';
    editPayer.innerHTML = ''; editParticipants.innerHTML = '';
    if(!g) return;
    if(!g.people.length) peopleList.innerHTML = '<div class="small-muted">No people yet</div>';
    g.people.forEach(p=>{
      const div = document.createElement('div'); div.className='person-chip'; div.textContent = p.name; div.dataset.pid = p.id; div.title='Tap to remove';
      peopleList.appendChild(div);
      // options
      const opt = document.createElement('option'); opt.value=p.id; opt.textContent=p.name; payerSelect.appendChild(opt);
      const opt2 = opt.cloneNode(true); editPayer.appendChild(opt2);
      // participant checkbox
      const cbWrap = document.createElement('label'); cbWrap.className='person-chip'; cbWrap.style.display='inline-flex'; cbWrap.style.alignItems='center';
      cbWrap.innerHTML = `<input type="checkbox" style="margin-right:8px" value="${p.id}">${p.name}`;
      participantsDiv.appendChild(cbWrap);
      const cbWrap2 = cbWrap.cloneNode(true); editParticipants.appendChild(cbWrap2);
    });
  }

  function renderCategories(){
    const g = cur();
    catList.innerHTML = '';
    categorySelect.innerHTML = '';
    editCategory.innerHTML='';
    if(!g) return;
    g.categories.forEach(c=>{
      const chip = document.createElement('div'); chip.className='category-chip'; chip.textContent = c; chip.dataset.cat = c; chip.title = 'Tap to remove';
      catList.appendChild(chip);
      const opt = document.createElement('option'); opt.value=c; opt.textContent=c; categorySelect.appendChild(opt);
      const opt2 = opt.cloneNode(true); editCategory.appendChild(opt2);
    });
  }

  // initial render
  renderAll();

})();
</script>
</body>
</html>
