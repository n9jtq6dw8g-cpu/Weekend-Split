<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekend Split â€” Minimal</title>
<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0f1724;
    --plate:#eef0f3;
    --success:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#fff,#f3f4f6);display:flex;align-items:center;justify-content:center;border:1px solid #e6e9ee;font-weight:700}
  h1{margin:0;font-size:18px;font-weight:600}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(15,23,36,0.06)}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(14,16,20,0.04);border:1px solid rgba(15,23,36,0.03);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:14px}
  @media(max-width:920px){.grid{grid-template-columns:1fr}.right{order:2}}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], input[type="number"], select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:#fff;font-size:14px;outline:none}
  .row{display:flex;gap:8px}
  .people-list{display:flex;flex-wrap:wrap;gap:8px}
  .person-chip, .category-chip{padding:6px 10px;background:var(--plate);border-radius:12px;font-weight:600;font-size:13px;border:1px solid rgba(15,23,36,0.03);cursor:pointer}
  .participant-checkbox{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;border:1px solid rgba(15,23,36,0.03);background:#fff;cursor:pointer}
  .participant-checkbox input{margin:0;pointer-events:none;}
  .expense{display:flex;justify-content:space-between;gap:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,36,0.03);margin-bottom:8px}
  .muted{color:var(--muted);font-size:13px}
  .tiny{padding:6px 8px;border-radius:8px;font-size:13px}
  .icon-btn{background:transparent;border:none;padding:6px;border-radius:8px;cursor:pointer}
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--plate);margin-bottom:8px;border:1px solid rgba(15,23,36,0.03)}
  .positive{color:var(--success);font-weight:700}
  .negative{color:var(--danger);font-weight:700}
  .footer{font-size:13px;color:var(--muted);display:flex;justify-content:space-between;margin-top:8px}
  .list-scroll{max-height:320px;overflow:auto;padding-right:6px}
  .select-inline{display:flex;gap:8px;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid rgba(15,23,36,0.04);font-weight:600}
  .center{display:flex;align-items:center;justify-content:center}
  .share-icon{font-size:18px;padding:8px;border-radius:8px;border:1px solid rgba(15,23,36,0.03);background:#fff;cursor:pointer}
  .modal-back{position:fixed;inset:0;background:rgba(10,12,15,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--card);padding:14px;border-radius:12px;width:min(640px,96%);box-shadow:0 20px 50px rgba(2,6,23,0.4)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">WS</div>
      <div>
        <h1>Weekend Split</h1>
      </div>
    </div>
  </header>

  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div class="select-inline">
        <label style="margin:0 6px 0 0;font-weight:600">Group</label>
        <select id="groupSelect"></select>
        <button id="newGroupBtn" class="btn ghost tiny">New</button>
        <button id="delGroupBtn" class="btn ghost tiny">Delete</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">People</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="personName" type="text" placeholder="Add person (e.g. Ramesh)">
          <button id="addPerson" class="btn tiny">Add</button>
        </div>
        <div style="margin-top:10px" id="peopleList" class="people-list"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Categories</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <input id="catName" type="text" placeholder="New category (eg. Food)">
          <button id="addCat" class="btn tiny">Add</button>
        </div>
        <div id="catList" class="people-list" style="margin-top:10px"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Add / Edit Expense</div>
        </div>

        <div style="margin-top:10px">
          <label>Payer</label>
          <select id="payerSelect"></select>

          <label>Amount</label>
          <input id="amountInput" type="number" min="0" step="1" />

          <label>Category</label>
          <select id="categorySelect"></select>

          <label>Participants</label>
          <div id="participants" style="display:flex;flex-direction:column;gap:8px;margin-top:6px"></div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveExpense" class="btn">Save</button>
            <button id="clearExpense" class="btn ghost">Clear</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Expenses</div>
          <div class="small-muted" id="expCount">0 items</div>
        </div>
        <div class="list-scroll" id="expensesList" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="right">
      <div class="card" id="summaryCard">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Summary</div>
          <div style="display:flex;gap:8px;align-items:center">
            <div id="shareBtn" class="share-icon" title="Share summary">ðŸ“¤</div>
          </div>
        </div>

        <div id="summaryWrap" style="margin-top:12px">
          <div id="categoryTotals" style="margin-top:8px"></div>
          <div id="summary" style="margin-top:8px"></div>
          <div id="transferResultInline" style="margin-top:8px"></div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="resetEntriesBtn" class="btn ghost tiny" style="flex:1">Reset Entries</button>
            <button id="copySummary" class="btn tiny" style="flex:1">Copy Summary Text</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="font-weight:700">Transfer To</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <select id="transferTo" style="flex:1"></select>
          <button id="computeTransfer" class="btn tiny">Compute</button>
        </div>

        <div id="transferResult" style="margin-top:12px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div id="modal" class="modal-back">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700" id="editTitle">Edit Expense</div>
      <button id="closeModal" class="icon-btn" title="Close">âœ•</button>
    </div>
    <div style="margin-top:10px">
      <label>Payer</label>
      <select id="editPayer"></select>
      <label>Amount</label>
      <input id="editAmount" type="number" min="0" step="1" />
      <label>Category</label>
      <select id="editCategory"></select>
      <label>Participants</label>
      <div id="editParticipants" class="people-list" style="margin-top:6px"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="applyEdit" class="btn">Apply</button>
        <button id="deleteExpense" class="btn ghost">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- html2canvas for sharing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
(function(){
  const STORAGE_KEY = 'ws_final_v3';
  const uid = ()=> Math.random().toString(36).slice(2,9);

  // DOM refs
  const groupSelect = document.getElementById('groupSelect');
  const newGroupBtn = document.getElementById('newGroupBtn');
  const delGroupBtn = document.getElementById('delGroupBtn');
  const addPersonBtn = document.getElementById('addPerson');
  const personName = document.getElementById('personName');
  const peopleList = document.getElementById('peopleList');
  const payerSelect = document.getElementById('payerSelect');
  const amountInput = document.getElementById('amountInput');
  const categorySelect = document.getElementById('categorySelect');
  const participantsDiv = document.getElementById('participants');
  const saveExpense = document.getElementById('saveExpense');
  const clearExpense = document.getElementById('clearExpense');
  const expensesList = document.getElementById('expensesList');
  const expCount = document.getElementById('expCount');
  const summaryDiv = document.getElementById('summary');
  const categoryTotalsDiv = document.getElementById('categoryTotals');
  const transferTo = document.getElementById('transferTo');
  const computeTransfer = document.getElementById('computeTransfer');
  const transferResult = document.getElementById('transferResult');
  const shareBtn = document.getElementById('shareBtn');
  const catName = document.getElementById('catName');
  const addCat = document.getElementById('addCat');
  const catList = document.getElementById('catList');
  const copySummary = document.getElementById('copySummary');
  const resetEntriesBtn = document.getElementById('resetEntriesBtn');
  const transferResultInline = document.getElementById('transferResultInline');
  const modal = document.getElementById('modal');
  const closeModal = document.getElementById('closeModal');
  const editPayer = document.getElementById('editPayer');
  const editAmount = document.getElementById('editAmount');
  const editCategory = document.getElementById('editCategory');
  const editParticipants = document.getElementById('editParticipants');
  const applyEdit = document.getElementById('applyEdit');
  const deleteExpenseBtn = document.getElementById('deleteExpense');

  let data={groups:[]};
  let currentGroupId=null;
  let editingId=null;

  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function load(){ const s=localStorage.getItem(STORAGE_KEY); if(s){ try{ data=JSON.parse(s); }catch(e){ data={groups:[]}; } } }
  function currentGroup(){ return data.groups.find(g=>g.id===currentGroupId)||null; }

  load();
  if(!data.groups.length){ const gid=uid(); data.groups=[{id:gid,name:'My Group',people:[],categories:['Food','Entertainment','Fuel','Shopping'],expenses:[]}]; currentGroupId=gid; save();}
  else currentGroupId=data.groups[0].id;

  function renderAll(){
    renderGroups(); renderPeople(); renderCategories(); renderExpenseForm(); renderExpenses(); renderSummary(); renderTransferSelect();
  }

  function renderGroups(){
    groupSelect.innerHTML='';
    data.groups.forEach(g=>{ const o=document.createElement('option'); o.value=g.id; o.textContent=g.name; if(g.id===currentGroupId) o.selected=true; groupSelect.appendChild(o); });
  }

  function renderPeople(){
    const g=currentGroup(); if(!g) return;
    peopleList.innerHTML=''; payerSelect.innerHTML=''; participantsDiv.innerHTML=''; editPayer.innerHTML=''; editParticipants.innerHTML='';
    if(!g.people.length) peopleList.innerHTML='<div class="muted">No people yet</div>';
    g.people.forEach(p=>{
      const chip=document.createElement('div'); chip.className='person-chip'; chip.textContent=p.name; chip.dataset.pid=p.id; chip.title='Click to select/remove'; chip.addEventListener('click',()=>{
        const cb=participantsDiv.querySelector(`input[value="${p.id}"]`);
        if(cb) cb.checked=!cb.checked;
      });
      peopleList.appendChild(chip);
      const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; payerSelect.appendChild(opt);
      const lab=document.createElement('div'); lab.className='participant-checkbox'; lab.innerHTML=`<label><input type="checkbox" value="${p.id}"> ${p.name}</label>`; lab.addEventListener('click',()=>{ const cb=lab.querySelector('input'); cb.checked=!cb.checked; }); participantsDiv.appendChild(lab);
    });
  }

  function renderCategories(){
    const g=currentGroup(); if(!g) return;
    catList.innerHTML=''; categorySelect.innerHTML=''; editCategory.innerHTML='';
    g.categories.forEach(c=>{
      const chip=document.createElement('div'); chip.className='category-chip'; chip.textContent=c; chip.dataset.cat=c; chip.title='Tap to remove'; chip.addEventListener('click',()=>{
        if(g.categories.length<=1) return alert('At least one category required');
        if(!confirm(`Remove category "${c}"?`)) return;
        g.categories=g.categories.filter(x=>x!==c); save(); renderAll();
      }); catList.appendChild(chip);
      const opt=document.createElement('option'); opt.value=c; opt.textContent=c; categorySelect.appendChild(opt);
      const opt2=opt.cloneNode(true); editCategory.appendChild(opt2);
    });
  }

  function renderExpenseForm(){ amountInput.value=''; participantsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false); }

  function renderExpenses(){
    const g=currentGroup(); expensesList.innerHTML=''; if(!g) return;
    expCount.textContent=g.expenses.length+' items';
    if(!g.expenses.length){ expensesList.innerHTML='<div class="muted">No expenses</div>'; return; }
    g.expenses.slice().reverse().forEach(ex=>{
      const div=document.createElement('div'); div.className='expense'; div.innerHTML=`<div>${ex.payerName} â†’ ${ex.amount} (${ex.category})</div><div><button class="icon-btn">âœŽ</button></div>`;
      div.querySelector('button').addEventListener('click',()=>{ editingId=ex.id; showEditModal(ex); });
      expensesList.appendChild(div);
    });
  }

  function showEditModal(ex){
    modal.style.display='flex';
    editPayer.value=ex.payer;
    editAmount.value=ex.amount;
    editCategory.value=ex.category;
    editParticipants.innerHTML='';
    currentGroup().people.forEach(p=>{
      const lab=document.createElement('div'); lab.className='participant-checkbox'; lab.innerHTML=`<label><input type="checkbox" value="${p.id}"> ${p.name}</label>`;
      if(ex.participants.includes(p.id)) lab.querySelector('input').checked=true;
      lab.addEventListener('click',()=>{ const cb=lab.querySelector('input'); cb.checked=!cb.checked; });
      editParticipants.appendChild(lab);
    });
  }

  closeModal.addEventListener('click',()=>{ modal.style.display='none'; });

  applyEdit.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    const ex=g.expenses.find(x=>x.id===editingId); if(!ex) return;
    ex.payer=editPayer.value; ex.payerName=g.people.find(p=>p.id===ex.payer)?.name||'Unknown';
    ex.amount=parseFloat(editAmount.value)||0;
    ex.category=editCategory.value;
    ex.participants=Array.from(editParticipants.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.value);
    save(); renderAll(); modal.style.display='none';
  });

  deleteExpenseBtn.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    g.expenses=g.expenses.filter(x=>x.id!==editingId); save(); renderAll(); modal.style.display='none';
  });

  saveExpense.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    const payer=payerSelect.value; const amount=parseFloat(amountInput.value)||0; const category=categorySelect.value;
    const participants=Array.from(participantsDiv.querySelectorAll('input[type=checkbox]:checked')).map(cb=>cb.value);
    if(!payer||!amount||!category||participants.length===0) return alert('Complete all fields');
    g.expenses.push({id:uid(), payer, payerName:g.people.find(p=>p.id===payer)?.name||'Unknown', amount, category, participants});
    save(); renderAll();
  });

  clearExpense.addEventListener('click',()=>{ amountInput.value=''; participantsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false); });

  function renderSummary(){
    const g=currentGroup(); if(!g) return;
    if(!g.expenses.length){ summaryDiv.innerHTML='No summary yet'; transferResultInline.innerHTML=''; categoryTotalsDiv.innerHTML=''; return; }
    const totals={}; g.categories.forEach(c=>totals[c]=0);
    g.expenses.forEach(ex=>totals[ex.category]+=(ex.amount));
    categoryTotalsDiv.innerHTML=Object.entries(totals).map(([c,v])=>`<div>${c}: ${v}</div>`).join('');
    // Person balance
    const bal={}; g.people.forEach(p=>bal[p.id]=0);
    g.expenses.forEach(ex=>{
      const share=ex.amount/ex.participants.length;
      ex.participants.forEach(pid=>{ if(pid!==ex.payer) bal[pid]-=share; bal[ex.payer]+=share*(ex.participants.includes(ex.payer)?1:0); });
    });
    summaryDiv.innerHTML=Object.entries(bal).map(([pid,v])=>{ const p=g.people.find(p=>p.id===pid)?.name||'Unknown'; return `<div class="${v>=0?'positive':'negative'}">${p}: ${v.toFixed(2)}</div>`; }).join('');
  }

  function renderTransferSelect(){
    const g=currentGroup(); if(!g) return;
    transferTo.innerHTML=''; g.people.forEach(p=>{ const opt=document.createElement('option'); opt.value=p.id; opt.textContent=p.name; transferTo.appendChild(opt); });
  }

  computeTransfer.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    const toId=transferTo.value; const toName=g.people.find(p=>p.id===toId)?.name||'Unknown';
    const bal={}; g.people.forEach(p=>bal[p.id]=0);
    g.expenses.forEach(ex=>{
      const share=ex.amount/ex.participants.length;
      ex.participants.forEach(pid=>{ if(pid!==ex.payer) bal[pid]-=share; bal[ex.payer]+=share*(ex.participants.includes(ex.payer)?1:0); });
    });
    const lines=[]; Object.entries(bal).forEach(([pid,v])=>{
      if(pid===toId) return;
      if(v>0) lines.push(`${toName} pays ${v.toFixed(2)} to ${g.people.find(p=>p.id===pid)?.name}`);
      else if(v<0) lines.push(`${g.people.find(p=>p.id===pid)?.name} pays ${(-v).toFixed(2)} to ${toName}`);
    });
    transferResultInline.innerHTML=lines.join('<br>');
  });

  shareBtn.addEventListener('click', async () => {
    const summaryElement = transferResultInline;
    if (!summaryElement) return;
    const canvas = await html2canvas(summaryElement, { backgroundColor: "#ffffff" });
    canvas.toBlob(async (blob) => {
        if (!blob) return;
        const file = new File([blob], "summary.png", { type: "image/png" });
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
                files: [file],
                title: 'Weekend Split Summary',
                text: 'Summary of expenses'
            }).catch(err => console.error(err));
        } else {
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'summary.png';
            a.click();
            URL.revokeObjectURL(url);
        }
    });
  });

  addPersonBtn.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    const name=personName.value.trim(); if(!name) return;
    const id=uid(); g.people.push({id,name}); save(); personName.value=''; renderAll();
  });

  addCat.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    const c=catName.value.trim(); if(!c) return; if(g.categories.includes(c)) return alert('Already exists');
    g.categories.push(c); save(); catName.value=''; renderAll();
  });

  newGroupBtn.addEventListener('click',()=>{
    const name=prompt('Group name?'); if(!name) return;
    const id=uid(); data.groups.push({id,name,people:[],categories:['Food','Entertainment','Fuel','Shopping'],expenses:[]}); currentGroupId=id; save(); renderAll();
  });

  delGroupBtn.addEventListener('click',()=>{
    if(!confirm('Delete current group?')) return;
    data.groups=data.groups.filter(g=>g.id!==currentGroupId);
    currentGroupId=data.groups.length?data.groups[0].id:null; save(); renderAll();
  });

  groupSelect.addEventListener('change',(e)=>{ currentGroupId=e.target.value; renderAll(); });

  resetEntriesBtn.addEventListener('click',()=>{
    const g=currentGroup(); if(!g) return;
    if(!confirm('Reset all entries?')) return;
    g.expenses=[]; save(); renderAll();
  });

  copySummary.addEventListener('click',()=>{ navigator.clipboard.writeText(transferResultInline.innerText); alert('Summary copied'); });

  renderAll();
})();
</script>
</body>
</html>
