<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weekend Split â€” Groups & Transfers</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0f1724;
    --plate:#eef0f3;
    --success:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--accent)}
  .wrap{max-width:980px;margin:18px auto;padding:16px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#fff,#f3f4f6);display:flex;align-items:center;justify-content:center;border:1px solid #e6e9ee;font-weight:700}
  h1{margin:0;font-size:18px;font-weight:600}
  .subtitle{font-size:13px;color:var(--muted);margin-top:2px}
  .controls{display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(15,23,36,0.06)}
  .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(14,16,20,0.04);border:1px solid rgba(15,23,36,0.03);margin-bottom:12px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
  @media(max-width:900px){.grid{grid-template-columns:1fr}.right{order:2}}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"], input[type="number"], select, textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ee;background:#fff;font-size:14px;outline:none}
  textarea{min-height:64px;resize:vertical}
  .row{display:flex;gap:8px}
  .small{font-size:13px;color:var(--muted)}
  .people-list{display:flex;flex-wrap:wrap;gap:8px}
  .person-chip{padding:6px 10px;background:var(--plate);border-radius:12px;font-weight:600;font-size:13px;border:1px solid rgba(15,23,36,0.03)}
  .expense{display:flex;justify-content:space-between;gap:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(15,23,36,0.03);margin-bottom:8px}
  .muted{color:var(--muted);font-size:13px}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  .tiny{padding:6px 8px;border-radius:8px;font-size:13px}
  .icon-btn{background:transparent;border:none;padding:6px;border-radius:8px;cursor:pointer}
  .summary-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--plate);margin-bottom:8px;border:1px solid rgba(15,23,36,0.03)}
  .positive{color:var(--success);font-weight:700}
  .negative{color:var(--danger);font-weight:700}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  .footer{font-size:13px;color:var(--muted);display:flex;justify-content:space-between;margin-top:8px}
  .file{display:none}
  .list-scroll{max-height:320px;overflow:auto;padding-right:6px}
  .select-inline{display:flex;gap:8px;align-items:center}
  .badge{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid rgba(15,23,36,0.04);font-weight:600}
  .small-muted{font-size:12px;color:var(--muted)}
  .center{display:flex;align-items:center;justify-content:center}
  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(10,12,15,0.45);display:none;align-items:center;justify-content:center;z-index:60}
  .modal{background:var(--card);padding:14px;border-radius:12px;width:min(640px,96%);box-shadow:0 20px 50px rgba(2,6,23,0.4)}
  .flex{display:flex;gap:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo">WS</div>
      <div>
        <h1>Weekend Split</h1>
        <div class="subtitle">Groups, editable entries, rounded amounts, transfer-to flow</div>
      </div>
    </div>
    <div class="controls">
      <button id="backupBtn" class="btn ghost tiny">Backup</button>
      <button id="downloadBtn" class="btn tiny">Download JSON</button>
      <button id="resetAll" class="btn ghost tiny">Reset All</button>
    </div>
  </header>

  <div class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
      <div class="select-inline">
        <label style="margin:0 6px 0 0;font-weight:600">Group</label>
        <select id="groupSelect"></select>
        <button id="newGroupBtn" class="btn ghost tiny">New Group</button>
        <button id="delGroupBtn" class="btn ghost tiny">Delete</button>
      </div>
      <div class="small-muted">Data saved locally on your browser</div>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div style="font-weight:700">People</div>
          <div class="small-muted">Tap names to remove</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="personName" type="text" placeholder="Add person (e.g. Ramesh)">
          <button id="addPerson" class="btn tiny">Add</button>
        </div>
        <div style="margin-top:10px" id="peopleList" class="people-list"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Add / Edit Expense</div>
          <div class="small-muted">Amounts are rounded to whole rupees</div>
        </div>

        <div style="margin-top:10px">
          <label>Payer</label>
          <select id="payerSelect"></select>

          <label>Amount</label>
          <input id="amountInput" type="number" min="0" step="1" />

          <label>Description (optional)</label>
          <input id="descInput" type="text" placeholder="Dinner at ABC" />

          <label>Participants</label>
          <div id="participants" class="people-list"></div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <button id="saveExpense" class="btn">Save</button>
            <button id="clearExpense" class="btn ghost">Clear</button>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Expenses</div>
          <div class="small-muted" id="expCount">0 items</div>
        </div>
        <div class="list-scroll" id="expensesList" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Weekend Summary</div>
          <div class="small-muted">Net balances (integers)</div>
        </div>

        <div id="summary" style="margin-top:10px"></div>

        <div class="hr" style="height:8px"></div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
          <div style="font-weight:700">Transfer flow</div>
          <div class="small-muted">Choose one person as temporary collector</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <select id="transferTo"></select>
          <button id="computeTransfer" class="btn tiny">Compute</button>
          <button id="copyTransfer" class="btn ghost tiny">Copy</button>
        </div>

        <div id="transferResult" style="margin-top:12px"></div>

        <div class="note">Flow logic: Debtors send their amounts to the selected person; that person then forwards amounts to other creditors.</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Quick Actions</div>
          <div class="small-muted">Backup / Restore</div>
        </div>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
          <button id="exportSummary" class="btn">Copy Summary Text</button>
          <button id="downloadBackup" class="btn ghost">Download Backup</button>
          <input id="uploadFile" type="file" accept="application/json" class="file" />
          <button id="restoreBtn" class="btn tiny">Restore from file</button>
        </div>
        <div class="footer"><div>Version 1.1</div><div class="small-muted">Local only â€¢ No accounts</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Edit modal -->
<div id="modal" class="modal-back">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700" id="editTitle">Edit Expense</div>
      <button id="closeModal" class="icon-btn" title="Close">âœ•</button>
    </div>
    <div style="margin-top:10px">
      <label>Payer</label>
      <select id="editPayer"></select>
      <label>Amount</label>
      <input id="editAmount" type="number" min="0" step="1" />
      <label>Description</label>
      <input id="editDesc" type="text" />
      <label>Participants</label>
      <div id="editParticipants" class="people-list" style="margin-top:6px"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="applyEdit" class="btn">Apply</button>
        <button id="deleteExpense" class="btn ghost">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Data model: groups => each has id,name,people[],expenses[]
  const uid = ()=> Math.random().toString(36).slice(2,9);
  let data = { groups: [] };
  const STORAGE_KEY = 'ws_groups_v1';
  let currentGroupId = null;
  let editExpenseId = null;

  // DOM refs
  const groupSelect = el('groupSelect');
  const newGroupBtn = el('newGroupBtn');
  const delGroupBtn = el('delGroupBtn');
  const addPersonBtn = el('addPerson');
  const personName = el('personName');
  const peopleList = el('peopleList');
  const payerSelect = el('payerSelect');
  const amountInput = el('amountInput');
  const descInput = el('descInput');
  const participantsDiv = el('participants');
  const saveExpense = el('saveExpense');
  const clearExpense = el('clearExpense');
  const expensesList = el('expensesList');
  const expCount = el('expCount');
  const summaryDiv = el('summary');
  const transferTo = el('transferTo');
  const computeTransfer = el('computeTransfer');
  const transferResult = el('transferResult');
  const copyTransfer = el('copyTransfer');
  const modal = el('modal');
  const closeModal = el('closeModal');
  const editPayer = el('editPayer');
  const editAmount = el('editAmount');
  const editDesc = el('editDesc');
  const editParticipants = el('editParticipants');
  const applyEdit = el('applyEdit');
  const deleteExpenseBtn = el('deleteExpense');
  const exportSummary = el('exportSummary');
  const downloadBackup = el('downloadBackup');
  const uploadFile = el('uploadFile');
  const restoreBtn = el('restoreBtn');
  const backupBtn = el('backupBtn');
  const downloadBtn = el('downloadBtn');
  const resetAll = el('resetAll');
  const delGroup = el('delGroupBtn');

  // helpers
  function el(id){ return document.getElementById(id); }
  function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
  function load(){ const s=localStorage.getItem(STORAGE_KEY); if(s) try{ data=JSON.parse(s);}catch(e){console.error(e);} }
  function currentGroup(){ return data.groups.find(g=>g.id===currentGroupId) || null; }

  // init
  load();
  if(!data.groups.length){
    const gId = uid();
    data.groups.push({id:gId, name:'Friends', people:[], expenses:[]});
    currentGroupId = gId;
    save();
  } else {
    currentGroupId = data.groups[0].id;
  }
  renderAll();

  // Group management
  newGroupBtn.addEventListener('click', ()=>{
    const name = prompt('Group name') || ('Group-'+(data.groups.length+1));
    const g = { id: uid(), name: name.trim(), people: [], expenses: []};
    data.groups.push(g);
    currentGroupId = g.id;
    save(); renderAll();
  });

  groupSelect.addEventListener('change', (e)=>{
    currentGroupId = e.target.value;
    renderAll();
  });

  delGroup.addEventListener('click', ()=>{
    const g = currentGroup();
    if(!g) return;
    if(!confirm('Delete group "'+g.name+'"? This will remove all people & expenses for this group.')) return;
    data.groups = data.groups.filter(x=>x.id!==g.id);
    currentGroupId = data.groups.length? data.groups[0].id : null;
    if(!currentGroupId){
      const gId = uid();
      data.groups.push({id:gId,name:'Friends',people:[],expenses:[]});
      currentGroupId = gId;
    }
    save(); renderAll();
  });

  // person management
  addPersonBtn.addEventListener('click', ()=>{
    const name = personName.value.trim();
    if(!name) return alert('Enter a name');
    const g = currentGroup();
    g.people.push({id:uid(), name});
    personName.value='';
    save(); renderAll();
  });

  // delegate remove person on click
  peopleList.addEventListener('click', (ev)=>{
    if(ev.target.dataset && ev.target.dataset.pid){
      const pid = ev.target.dataset.pid;
      const g = currentGroup();
      if(!confirm('Remove '+ev.target.textContent+'? This will remove them from existing expenses.')) return;
      // remove from people
      g.people = g.people.filter(p=>p.id!==pid);
      // remove from expenses or participants
      g.expenses = g.expenses.map(ex=>({...ex, participants: ex.participants.filter(id=>id!==pid), payer: ex.payer===pid? (g.people[0]?g.people[0].id:null): ex.payer }))
                          .filter(ex=>ex.participants && ex.participants.length>0);
      save(); renderAll();
    }
  });

  // render functions
  function renderAll(){
    renderGroups();
    renderPeople();
    renderExpenseForm();
    renderExpenses();
    renderSummary();
    renderTransferSelect();
  }

  function renderGroups(){
    groupSelect.innerHTML='';
    data.groups.forEach(g=>{
      const opt = document.createElement('option'); opt.value=g.id; opt.textContent=g.name;
      if(g.id===currentGroupId) opt.selected = true;
      groupSelect.appendChild(opt);
    });
  }

  function renderPeople(){
    const g = currentGroup();
    peopleList.innerHTML='';
    payerSelect.innerHTML='';
    transferTo.innerHTML='';
    participantsDiv.innerHTML='';
    editPayer.innerHTML=''; editParticipants.innerHTML='';
    if(!g) return;
    if(!g.people.length) peopleList.innerHTML = '<div class="small-muted">No people yet</div>';
    g.people.forEach(p=>{
      const span = document.createElement('div');
      span.className='person-chip';
      span.textContent = p.name;
      span.dataset.pid = p.id;
      span.title = 'Tap to remove';
      peopleList.appendChild(span);
      // payer option
      const opt = document.createElement('option'); opt.value=p.id; opt.textContent=p.name;
      payerSelect.appendChild(opt);
      const opt2 = opt.cloneNode(true); transferTo.appendChild(opt2);
      const opt3 = opt.cloneNode(true); editPayer.appendChild(opt3);
      // participant checkbox
      const cb = document.createElement('label');
      cb.className='person-chip';
      cb.style.display='inline-flex'; cb.style.alignItems='center';
      cb.innerHTML = `<input type="checkbox" style="margin-right:8px" value="${p.id}">${p.name}`;
      participantsDiv.appendChild(cb);
      // edit participants
      const cb2 = cb.cloneNode(true);
      editParticipants.appendChild(cb2);
    });
  }

  function renderExpenseForm(){
    // clear defaults
    amountInput.value=''; descInput.value=''; // participants unchecked handled by re-render
  }

  function renderExpenses(){
    const g = currentGroup();
    expensesList.innerHTML='';
    if(!g) return;
    expCount.textContent = g.expenses.length + ' items';
    if(g.expenses.length===0) { expensesList.innerHTML = '<div class="small-muted">No expenses</div>'; return; }
    g.expenses.slice().reverse().forEach(ex=>{
      const payer = g.people.find(p=>p.id===ex.payer)?.name || 'Unknown';
      const names = ex.participants.map(id=> g.people.find(p=>p.id===id)?.name || '?').join(', ');
      const div = document.createElement('div'); div.className='expense';
      const left = document.createElement('div');
      left.innerHTML = `<div style="font-weight:700">${ex.desc || 'Expense'}</div>
                        <div class="muted">${payer} paid â€¢ â‚¹${ex.amt} â€¢ ${names}</div>
                        <div class="small-muted">${new Date(ex.ts).toLocaleString()}</div>`;
      const right = document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.gap='8px';
      const editB = document.createElement('button'); editB.className='tiny icon-btn'; editB.title='Edit'; editB.innerHTML='âœŽ';
      editB.addEventListener('click', ()=> openEdit(ex.id));
      const delB = document.createElement('button'); delB.className='tiny icon-btn'; delB.title='Delete'; delB.innerHTML='ðŸ—‘';
      delB.addEventListener('click', ()=>{ if(confirm('Delete this expense?')){ g.expenses = g.expenses.filter(x=>x.id!==ex.id); save(); renderAll(); }});
      right.appendChild(editB); right.appendChild(delB);
      div.appendChild(left); div.appendChild(right);
      expensesList.appendChild(div);
    });
  }

  // save expense (new)
  saveExpense.addEventListener('click', ()=>{
    const g = currentGroup();
    if(!g) return alert('No group');
    const payer = payerSelect.value;
    let amt = Math.round(Number(amountInput.value || 0));
    if(!payer) return alert('Select payer');
    if(!amt || amt<=0) return alert('Enter amount');
    const desc = descInput.value.trim();
    const parts = Array.from(participantsDiv.querySelectorAll('input[type=checkbox]')).filter(ch=>ch.checked).map(ch=>ch.value);
    if(parts.length===0) return alert('Select participants');
    const ex = { id: uid(), payer, amt: Math.round(amt), participants: parts, desc, ts: Date.now() };
    g.expenses.push(ex);
    save();
    amountInput.value=''; descInput.value=''; participantsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
    renderAll();
  });

  clearExpense.addEventListener('click', ()=>{ amountInput.value=''; descInput.value=''; participantsDiv.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false); });

  // edit modal
  function openEdit(eid){
    const g = currentGroup();
    const ex = g.expenses.find(x=>x.id===eid); if(!ex) return;
    editExpenseId = eid;
    modal.style.display='flex';
    editPayer.value = ex.payer;
    editAmount.value = ex.amt;
    editDesc.value = ex.desc||'';
    // check participants
    editParticipants.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.checked = ex.participants.includes(cb.value));
  }
  closeModal.addEventListener('click', ()=>{ modal.style.display='none'; editExpenseId=null; });

  applyEdit.addEventListener('click', ()=>{
    const g = currentGroup(); if(!g || !editExpenseId) return;
    const ex = g.expenses.find(x=>x.id===editExpenseId); if(!ex) return;
    const payer = editPayer.value;
    const amt = Math.round(Number(editAmount.value || 0));
    const desc = editDesc.value.trim();
    const parts = Array.from(editParticipants.querySelectorAll('input[type=checkbox]')).filter(ch=>ch.checked).map(ch=>ch.value);
    if(!payer) return alert('Select payer');
    if(!amt || amt<=0) return alert('Enter amount');
    if(parts.length===0) return alert('Select participants');
    ex.payer = payer; ex.amt = Math.round(amt); ex.desc = desc; ex.participants = parts; ex.ts = Date.now();
    save(); modal.style.display='none'; editExpenseId=null; renderAll();
  });

  deleteExpenseBtn.addEventListener('click', ()=>{
    if(!confirm('Delete this expense?')) return;
    const g = currentGroup();
    g.expenses = g.expenses.filter(x=>x.id!==editExpenseId);
    save(); modal.style.display='none'; editExpenseId=null; renderAll();
  });

  // compute balances
  function computeBalances(){
    const g = currentGroup();
    const bal = {};
    g.people.forEach(p=> bal[p.id]=0);
    g.expenses.forEach(e=>{
      // split equally among participants (rounded)
      const n = e.participants.length;
      const shareBase = Math.floor(e.amt / n);
      let remainder = e.amt - shareBase * n;
      // assign shareBase to all, distribute remainder +1 to first 'remainder' participants
      e.participants.forEach((pid, idx)=>{
        let share = shareBase + (remainder>0?1:0);
        if(remainder>0) remainder--;
        // each participant owes share
        bal[pid] = (bal[pid] || 0) - share;
      });
      // payer paid full amount
      bal[e.payer] = (bal[e.payer] || 0) + e.amt;
    });
    // round to integers (they already are)
    for(const k in bal) bal[k] = Math.round(bal[k]);
    return bal;
  }

  function renderSummary(){
    const g = currentGroup();
    summaryDiv.innerHTML='';
    if(!g) return;
    const bal = computeBalances();
    // display sorted by amount desc
    const list = g.people.map(p=>({id:p.id,name:p.name,amt:bal[p.id]||0})).sort((a,b)=>b.amt-a.amt);
    list.forEach(item=>{
      const row = document.createElement('div'); row.className='summary-row';
      const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${item.name}</div><div class="small-muted">Net</div>`;
      const right = document.createElement('div'); right.innerHTML = `<div class="${item.amt>=0?'positive':'negative'}">â‚¹${Math.abs(item.amt)}</div>`;
      row.appendChild(left); row.appendChild(right);
      summaryDiv.appendChild(row);
    });
  }

  // transfer flow
  computeTransfer.addEventListener('click', ()=> {
    const g = currentGroup(); if(!g) return;
    const toId = transferTo.value;
    if(!toId) return alert('Select transfer-to person');
    const bal = computeBalances();
    const creditors = []; const debtors = [];
    for(const pid in bal){
      const v = bal[pid];
      if(v>0) creditors.push({id:pid,amt:v});
      else if(v<0) debtors.push({id:pid,amt:-v});
    }
    // Build debtor -> toId transfers: each debtor pays their owed to 'toId'
    const ops = [];
    let totalToReceive = 0;
    debtors.forEach(d=>{ ops.push({from:d.id,to:toId,amt:d.amt}); totalToReceive += d.amt; });
    // After receiving, 'toId' will have bal[toId] + totalToReceive
    const toInitial = bal[toId] || 0;
    const toAfter = toInitial + totalToReceive;
    // Now, other creditors (excluding toId) need to be paid from toId if toAfter > 0
    const otherCreditors = creditors.filter(c=>c.id !== toId).map(c=>({...c}));
    let remaining = toAfter;
    otherCreditors.forEach(c=>{
      if(remaining<=0) return;
      const pay = Math.min(remaining, c.amt);
      if(pay>0) { ops.push({from:toId,to:c.id,amt:pay}); remaining -= pay; }
    });
    // Render result
    transferResult.innerHTML='';
    if(ops.length===0){ transferResult.innerHTML = '<div class="small-muted">Nothing to transfer â€” everyone settled</div>'; return;}
    const gmap = {};
    g.people.forEach(p=> gmap[p.id]=p.name);
    ops.forEach(op=>{
      const div = document.createElement('div'); div.className='summary-row';
      div.innerHTML = `<div>${gmap[op.from] || '?' } â†’ ${gmap[op.to] || '?'}</div><div class="badge">â‚¹${op.amt}</div>`;
      transferResult.appendChild(div);
    });
  });

  copyTransfer.addEventListener('click', ()=>{
    const txt = transferResult.innerText || '';
    if(!txt) return alert('No transfer result to copy');
    navigator.clipboard.writeText(txt).then(()=> alert('Copied'));
  });

  function renderTransferSelect(){
    const g = currentGroup();
    transferTo.innerHTML='';
    if(!g) return;
    g.people.forEach(p=> { const opt = document.createElement('option'); opt.value=p.id; opt.textContent=p.name; transferTo.appendChild(opt); });
  }

  // Export / backup / restore
  exportSummary.addEventListener('click', ()=>{
    const g = currentGroup(); if(!g) return;
    const bal = computeBalances();
    let s = `Weekend Split â€” ${g.name}\n\nPeople:\n` + g.people.map(p=>`- ${p.name}`).join('\n') + '\n\nExpenses:\n' + g.expenses.map(e=>`- ${e.desc || 'Expense'}: â‚¹${e.amt} (paid by ${g.people.find(x=>x.id===e.payer)?.name || '?'})`).join('\n') + '\n\nNet balances:\n' + g.people.map(p=>`${p.name}: â‚¹${Math.round(bal[p.id]||0)}`).join('\n');
    navigator.clipboard.writeText(s).then(()=> alert('Summary copied to clipboard'));
  });

  downloadBackup.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = 'ws-backup.json'; a.click(); URL.revokeObjectURL(url);
  });

  backupBtn.addEventListener('click', ()=>{
    navigator.clipboard.writeText(JSON.stringify(data)).then(()=> alert('Backup copied to clipboard'));
  });

  downloadBtn.addEventListener('click', ()=>{
    const s = JSON.stringify(data);
    const blob = new Blob([s], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='ws-data.json'; a.click(); URL.revokeObjectURL(url);
  });

  restoreBtn.addEventListener('click', ()=> uploadFile.click());
  uploadFile.addEventListener('change', (ev)=>{
    const f = ev.target.files[0]; if(!f) return;
    const rdr = new FileReader();
    rdr.onload = e=>{ try{ const obj = JSON.parse(e.target.result); data = obj; if(data.groups && data.groups.length) currentGroupId = data.groups[0].id; save(); renderAll(); alert('Restored'); }catch(err){ alert('Invalid file') } };
    rdr.readAsText(f);
  });

  resetAll.addEventListener('click', ()=>{
    if(!confirm('Clear all groups & data?')) return;
    data = { groups: [] };
    const gId = uid();
    data.groups.push({id:gId,name:'Friends',people:[],expenses:[]});
    currentGroupId = gId;
    save(); renderAll();
  });

  // initial small UI hook: close modal when clicking outside
  modal.addEventListener('click', (ev)=>{ if(ev.target===modal) { modal.style.display='none'; editExpenseId=null; } });

})();
</script>
</body>
</html>
